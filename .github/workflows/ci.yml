name: CI

on:
    push:
        branches: [main, release/stable]
    pull_request:
        branches: [main, feature/*, release/*]

jobs:
    build-vs2019:
        name: VS 2019
        runs-on: windows-2019
        env:
            TEST_REPORT_HTML: TestResults/toolkit-test-results.html

        strategy:
            matrix:
                configuration: [Debug, Release]

        steps:
            - uses: actions/checkout@v2
            - name: Add msbuild to PATH
              uses: microsoft/setup-msbuild@v1.0.2
              with:
                  vs-version: "[16.0,17.0)"

            - name: Restore
              run: msbuild buildtools\build.proj /t:restore /p:Configuration=${{ matrix.configuration }}

            - name: Verify
              run: msbuild buildtools\build.proj /t:verify

            - name: Compile
              # DeployExtension=false skips installing the extension into an experimental instance of VS (we aren't going to debug it on CI machine)
              # This increases build time dramatically and prevents cryptic DEVENV warning spam.
              run: msbuild buildtools\build.proj /t:compile /p:DeployExtension=false /p:Configuration=${{ matrix.configuration }}

            - name: Test
              run: msbuild buildtools\build.proj /t:test /p:Configuration=${{ matrix.configuration }}

            - name: Attach Test Report as Build Artifact
              if: always()
              uses: actions/upload-artifact@v2
              with:
                  name: test-reports-vs2019-${{ matrix.configuration }}
                  path: ${{ env.TEST_REPORT_HTML }}

version: 0.2

phases:
    pre_build:
        commands:
            - |
             git clone https://github.com/awslabs/git-secrets /tmp/git-secrets/; cd /tmp/git-secrets/
             echo "Installing git secrets.."
             ./install.ps1
             cd $Env:CODEBUILD_SRC_DIR
    build:
        commands:
            - git init
            - echo "Building.."; msbuild buildtools\build.proj /t:restore 
            - echo "Verifying.."; msbuild buildtools\build.proj /t:verify
            - msbuild buildtools\build.proj /t:compile /p:DeployExtension=false /p:Configuration=$env:BUILD_CONFIGURATION
            - echo "Running Tests.."; msbuild buildtools\build.proj /t:test /p:DeployExtension=false  /p:Configuration=$env:BUILD_CONFIGURATION
    post_build:
        commands:
            - |
             echo "Running git secrets check .."
             $Env:Path += ";$($Env:USERPROFILE)\\.git-secrets"
             git secrets --install
             git secrets --register-aws
             git secrets --scan --untracked
artifacts:
    discard-paths: yes
    files:
        - Deployment\**\*.vsix

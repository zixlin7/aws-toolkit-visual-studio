version: 0.2

phases:
    install:
        commands:
            # Fix for 'filename too long' errors
            # LongPathsEnabled Reference:
            # https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file#enable-long-paths-in-windows-10-version-1607-and-later
            - '& Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name LongPathsEnabled -Value 1'
    pre_build:
        commands:
            - |
             git clone https://github.com/awslabs/git-secrets /tmp/git-secrets/; cd /tmp/git-secrets/
             echo "Installing git secrets.."
             ./install.ps1
             cd $Env:CODEBUILD_SRC_DIR
    build:
        commands:
            - git init
            - echo "Building.."; msbuild buildtools\build.proj /t:restore /p:NuGetDisableParallelProcessing=true
            - echo "Verifying.."; msbuild buildtools\build.proj /t:verify
            - msbuild buildtools\build.proj /t:compile /p:DeployExtension=false /p:Configuration=$env:BUILD_CONFIGURATION
            - echo "Running Tests.."; msbuild buildtools\build.proj /t:test /p:DeployExtension=false  /p:Configuration=$env:BUILD_CONFIGURATION
    post_build:
        commands:
            - |
             echo "Running git secrets check .."
             $Env:Path += ";$($Env:USERPROFILE)\\.git-secrets"
             git secrets --install
             git secrets --register-aws
             git secrets --scan --untracked
artifacts:
    discard-paths: yes
    files:
        - Deployment\**\*.vsix
